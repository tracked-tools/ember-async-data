{"version":3,"file":"tracked-async-data.js","sources":["../src/tracked-async-data.ts"],"sourcesContent":["import { tracked } from '@glimmer/tracking';\nimport { dependentKeyCompat } from '@ember/object/compat';\nimport { deprecate } from '@ember/debug';\nimport { buildWaiter } from '@ember/test-waiters';\n\nconst waiter = buildWaiter('ember-async-data');\n\n/** A very cheap representation of the of a promise. */\ntype StateRepr<T> =\n  | [tag: 'PENDING']\n  | [tag: 'RESOLVED', value: T]\n  | [tag: 'REJECTED', error: unknown];\n\n// We only need a single instance of the pending state in our system, since it\n// is otherwise unparameterized (unlike the resolved and rejected states).\nconst PENDING = ['PENDING'] as [tag: 'PENDING'];\n\n// This class exists so that the state can be *wholly* private to outside\n// consumers, but its tracked internals can be both read and written directly by\n// `TrackedAsyncData` itself. The initial state of every `TrackedAsyncData` is\n// `PENDING`, though it may immediately become resolved for some `Promise`\n// instances (e.g. with a `Promise.resolve`).\nclass State<T> {\n  @tracked data: StateRepr<T> = PENDING;\n}\n\n// NOTE: this class is the implementation behind the types; the public types\n// layer on additional safety. See below! Additionally, the docs for the class\n// itself are applied to the export, not to the class, so that they will appear\n// when users refer to *that*.\nclass _TrackedAsyncData<T> {\n  #token: unknown;\n\n  /**\n    @param promise The promise to load.\n   */\n  constructor(data: T | Promise<T>) {\n    if (this.constructor !== _TrackedAsyncData) {\n      throw new Error('tracked-async-data cannot be subclassed');\n    }\n\n    if (!isPromiseLike(data)) {\n      this.#state.data = ['RESOLVED', data];\n      return;\n    }\n\n    const promise = data;\n    this.#token = waiter.beginAsync();\n\n    // Otherwise, we know that haven't yet handled that promise anywhere in the\n    // system, so we continue creating a new instance.\n    promise.then(\n      (value) => {\n        this.#state.data = ['RESOLVED', value];\n        waiter.endAsync(this.#token);\n      },\n      (error) => {\n        this.#state.data = ['REJECTED', error];\n        waiter.endAsync(this.#token);\n      },\n    );\n  }\n\n  /**\n    The internal state management for the promise.\n\n    - `readonly` so it cannot be mutated by the class itself after instantiation\n    - uses true native privacy so it cannot even be read (and therefore *cannot*\n      be depended upon) by consumers.\n   */\n  readonly #state = new State<T>();\n\n  /**\n   * The resolution state of the promise.\n   */\n  @dependentKeyCompat\n  get state(): State<T>['data'][0] {\n    return this.#state.data[0];\n  }\n\n  /**\n    The value of the resolved promise.\n\n    @note It is only valid to access `error` when `.isError` is true, that is,\n      when `TrackedAsyncData.state` is `\"ERROR\"`.\n    @warning You should not rely on this returning `T | null`! In a future\n      breaking change which drops support for pre-Octane idioms, it will *only*\n      return `T` and will *throw* if you access it when the state is wrong.\n   */\n  @dependentKeyCompat\n  get value(): T | null {\n    deprecate(\n      \"Accessing `value` when TrackedAsyncData is not in the resolved state is not supported and will throw an error in the future. Always check that `.state` is `'RESOLVED'` or that `.isResolved` is `true` before accessing this property.\",\n      this.#state.data[0] === 'RESOLVED',\n      {\n        id: 'tracked-async-data::invalid-value-access',\n        for: 'ember-async-data',\n        since: {\n          available: '1.0.0',\n          enabled: '1.0.0',\n        },\n        until: '2.0.0',\n      },\n    );\n\n    return this.#state.data[0] === 'RESOLVED' ? this.#state.data[1] : null;\n  }\n\n  /**\n    The error of the rejected promise.\n\n    @note It is only valid to access `error` when `.isError` is true, that is,\n      when `TrackedAsyncData.state` is `\"ERROR\"`.\n    @warning You should not rely on this returning `null` when the state is not\n      `\"ERROR\"`! In a future breaking change which drops support for pre-Octane\n      idioms, it will *only* return `E` and will *throw* if you access it when\n      the state is wrong.\n   */\n  @dependentKeyCompat\n  get error(): unknown {\n    deprecate(\n      \"Accessing `error` when TrackedAsyncData is not in the rejected state is not supported and will throw an error in the future. Always check that `.state` is `'REJECTED'` or that `.isRejected` is `true` before accessing this property.\",\n      this.#state.data[0] === 'REJECTED',\n      {\n        id: 'tracked-async-data::invalid-error-access',\n        for: 'ember-async-data',\n        since: {\n          available: '1.0.0',\n          enabled: '1.0.0',\n        },\n        until: '2.0.0',\n      },\n    );\n\n    return this.#state.data[0] === 'REJECTED' ? this.#state.data[1] : null;\n  }\n\n  /**\n    Is the state `\"PENDING\"`.\n   */\n  @dependentKeyCompat\n  get isPending(): boolean {\n    return this.state === 'PENDING';\n  }\n\n  /** Is the state `\"RESOLVED\"`? */\n  @dependentKeyCompat\n  get isResolved(): boolean {\n    return this.state === 'RESOLVED';\n  }\n\n  /** Is the state `\"REJECTED\"`? */\n  @dependentKeyCompat\n  get isRejected(): boolean {\n    return this.state === 'REJECTED';\n  }\n\n  // SAFETY: casts are safe because we uphold these invariants elsewhere in the\n  // class. It would be great if we could guarantee them statically, but getters\n  // do not return information about the state of the class well.\n  toJSON(): JSONRepr<T> {\n    const { isPending, isResolved, isRejected } = this;\n    if (isPending) {\n      return { isPending, isResolved, isRejected } as JSONRepr<T>;\n    } else if (isResolved) {\n      return {\n        isPending,\n        isResolved,\n        value: this.value,\n        isRejected,\n      } as JSONRepr<T>;\n    } else {\n      return {\n        isPending,\n        isResolved,\n        isRejected,\n        error: this.error,\n      } as JSONRepr<T>;\n    }\n  }\n\n  toString(): string {\n    return JSON.stringify(this.toJSON(), null, 2);\n  }\n}\n\n/**\n  The JSON representation of a `TrackedAsyncData`, useful for e.g. logging.\n\n  Note that you cannot reconstruct a `TrackedAsyncData` *from* this, because it\n  is impossible to get the original promise when in a pending state!\n */\nexport type JSONRepr<T> =\n  | { isPending: true; isResolved: false; isRejected: false }\n  | { isPending: false; isResolved: true; isRejected: false; value: T }\n  | { isPending: false; isResolved: false; isRejected: true; error: unknown };\n\n// The exported type is the intersection of three narrowed interfaces. Doing it\n// this way has two nice benefits:\n//\n// 1.  It allows narrowing to work. For example:\n//\n//     ```ts\n//     let data = new TrackedAsyncData(Promise.resolve(\"hello\"));\n//     if (data.isPending) {\n//       data.value;  // null\n//       data.error;  // null\n//     } else if (data.isPending) {\n//       data.value;  // null\n//       data.error;  // null\n//     } else if (data.isRejected) {\n//       data.value;  // null\n//       data.error;  // unknown, can now be narrowed\n//     }\n//     ```\n//\n//     This dramatically improves the usability of the type in type-aware\n//     contexts (including with templates when using Glint!)\n//\n// 2.  Using `interface extends` means that (a) it is guaranteed to be a subtype\n//     of the `_TrackedAsyncData` type, (b) that the docstrings applied to the\n//     base type still work, and (c) that the types which are *common* to the\n//     shared implementations (i.e. `.toJSON()` and `.toString()`) are shared\n//     automatically.\n\ninterface Pending<T> extends _TrackedAsyncData<T> {\n  state: 'PENDING';\n  isPending: true;\n  isResolved: false;\n  isRejected: false;\n  value: null;\n  error: null;\n}\n\ninterface Resolved<T> extends _TrackedAsyncData<T> {\n  state: 'RESOLVED';\n  isPending: false;\n  isResolved: true;\n  isRejected: false;\n  value: T;\n  error: null;\n}\n\ninterface Rejected<T> extends _TrackedAsyncData<T> {\n  state: 'REJECTED';\n  isPending: false;\n  isResolved: false;\n  isRejected: true;\n  value: null;\n  error: unknown;\n}\n\n/**\n  An autotracked `Promise` handler, representing asynchronous data.\n\n  Given a `Promise` instance, a `TrackedAsyncData` behaves exactly lik the\n  original `Promise`, except that it makes the state of the `Promise` visible\n  via tracked state, so you can check whether the promise is pending, resolved,\n  or rejected; and so you can get the value if it has resolved or the error if\n  it has rejected.\n\n  Every `Promise` in the system is guaranteed to be associated with at most a\n  single `TrackedAsyncData`.\n\n  ## Example\n\n  ```ts\n  import Component from '@glimmer/component';\n  import { cached } from '@glimmer/tracking';\n  import { inject as service } from '@ember/service';\n  import TrackedAsyncData from 'ember-async-data/tracked-async-data';\n\n  export default class SmartProfile extends Component<{ id: number }> {\n    @service store;\n\n    @cached\n    get someData() {\n      let recordPromise = this.store.findRecord('user', this.args.id);\n      return new TrackedAsyncData(recordPromise);\n    }\n  }\n  ```\n\n  And a corresponding template:\n\n  ```hbs\n  {{#if this.someData.isResolved}}\n    <PresentTheData @data={{this.someData.data}} />\n  {{else if this.someData.isPending}}\n    <LoadingSpinner />\n  {{else if this.someData.isRejected}}\n    <p>\n      Whoops! Looks like something went wrong!\n      {{this.someData.error.message}}\n    </p>\n  {{/if}}\n  ```\n */\ntype TrackedAsyncData<T> = Pending<T> | Resolved<T> | Rejected<T>;\nconst TrackedAsyncData = _TrackedAsyncData as new <T>(\n  data: T | Promise<T>,\n) => TrackedAsyncData<T>;\nexport default TrackedAsyncData;\n\n/** Utility type to check whether the string `key` is a property on an object */\nfunction has<K extends PropertyKey, T extends object>(\n  key: K,\n  t: T,\n): t is T & Record<K, unknown> {\n  return key in t;\n}\n\nfunction isPromiseLike(data: unknown): data is PromiseLike<unknown> {\n  return (\n    typeof data === 'object' &&\n    data !== null &&\n    has('then', data) &&\n    typeof data.then === 'function'\n  );\n}\n"],"names":["waiter","buildWaiter","PENDING","State","_class","constructor","_initializerDefineProperty","_descriptor","_applyDecoratedDescriptor","prototype","tracked","configurable","enumerable","writable","initializer","_TrackedAsyncData","_class2","_token","WeakMap","_state","data","_classPrivateFieldInitSpec","Error","isPromiseLike","_classPrivateFieldGet","promise","_classPrivateFieldSet","beginAsync","then","value","endAsync","error","state","deprecate","id","for","since","available","enabled","until","isPending","isResolved","isRejected","toJSON","toString","JSON","stringify","dependentKeyCompat","Object","getOwnPropertyDescriptor","TrackedAsyncData","has","key","t"],"mappings":"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ACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AA6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEMkC,MAAAA,gBAAgB,GAAGnC,kBAED;;AAGxB;AACA,SAASoC,GAAGA,CACVC,GAAM,EACNC,CAAI,EACyB;EAC7B,OAAOD,GAAG,IAAIC,CAAC,CAAA;AACjB,CAAA;AAEA,SAAS9B,aAAaA,CAACH,IAAa,EAAgC;EAClE,OACE,OAAOA,IAAI,KAAK,QAAQ,IACxBA,IAAI,KAAK,IAAI,IACb+B,GAAG,CAAC,MAAM,EAAE/B,IAAI,CAAC,IACjB,OAAOA,IAAI,CAACQ,IAAI,KAAK,UAAU,CAAA;AAEnC;;;;"}